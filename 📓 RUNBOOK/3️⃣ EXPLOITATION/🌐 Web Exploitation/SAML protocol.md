#Exploit_noti 

- [[#Signature Striping]]
- [[#Comment Injection I]]
- [[#SSRF]]
- [[#Malicious IDP]]
- [[#Signature Wrapping]]

---
# Descrizione 

Il **Security Assertion Markup Language (SAML)** è uno **standard aperto** che consente ai **provider di identità (IdP)** di trasmettere le credenziali di autorizzazione ai **provider di servizi (SP)**.

Detto in parole semplici, questo significa che puoi usare **un solo set di credenziali per accedere a diversi siti web**. È molto più semplice gestire **un unico login per utente**, piuttosto che accessi separati a email, software CRM (Customer Relationship Management), Active Directory, ecc.

Le transazioni SAML usano **XML (Extensible Markup Language)** per una comunicazione standardizzata tra il provider di identità e i provider di servizi.

![[SAML_protocol.png]]

### NB: è fortemente consigliato l'uso dell'estensione SAMLRaider scaricabile su Burpsuite per la modifica del parametro SAMLResponse

---
# Signature Striping

Il parametro **SAMLResponse** è passato durante l'autenticazione dell'utente in *base64* tramite comunicazione XML. È possibile catturare la richiesta con *Burpsuite*, decodificare il contenuto del parametro e cambiare l'indirizzo email nel tag ```<NameID>``` in quello dell'utente amministratore (es:admin@libero.it) e rimuovere la firma dell'account eliminando il contenuto del tag `<ds:SignatureValue>` in modo da lasciarlo vuoto *(writeup: https://pentesterlab.com/exercises/saml-ii)*.

---
# Comment Injection I

Il **Service Provider rimuove i commenti XML** dall'indirizzo email fornito nella `SAMLResponse` dall’IDP. Per sfruttare questo problema, devi:

1. Registrare un account sull’IDP con un indirizzo email che, una volta rimossi i commenti XML, diventi admin@libcurl.so (es: *'admin<!--test-->@libcurl.so'*)
2. Effettuare il login tramite SAML partendo dal Service Provider

*(writeup: https://pentesterlab.com/exercises/saml-iii)*

Oppure:

1. Registrare un account sull’IDP con un indirizzo email che, una volta rimossi i commenti XML, diventi admin@libcurl.so (es: *'admin@libcurl.so.hack'*)
2. Effettua il login con l'utente registrato ed intercetta la richiesta
3. Cambia la richiesta **SAMLResponse** con *SAMLRaider,* modificando il tag ```<NameID>``` in admin@libcrul.so<!--test-->.hack

*(writeup: https://pentesterlab.com/exercises/saml-ix)*

---
# SSRF

Questo comportamento permette a un attaccante di creare una **SAMLResponse** modificata, dove il campo `<ds:Reference>` non punta più a un ID interno del file, ma a un URL esterno scelto dall'attaccante. Quando il server processa questa risposta, finisce per **fare una richiesta HTTP** verso l’indirizzo indicato.

Questa situazione è un classico esempio di **Server-Side Request Forgery (SSRF)**: l’attaccante sfrutta il server vulnerabile per mandare richieste verso sistemi interni o protetti.

Per sfruttare questa vulnerabilità, l'attaccante deve:
1. Catturare una **SAMLResponse** tramite *Burpsuite*
2. Decodifica il contenuto (Base64 + URL-decoding).
3. Modificare il campo `<ds:Reference>` per puntare a un indirizzo HTTP a sua scelta (esempio: http://malevolo.com).
4. Svuotare il contenuto del tag `<ds:SignatureValue>` per evitare errori di firma.
5. Ricodificare il tutto (Base64 + URL-encoding).
6. Inviarla al Service Provider.

Quando il server processa la **SAMLResponse**, seguirà il link malevolo e, se configurato male, potrà rivelare dati, chiavi o flags importanti.

(*writeup: https://pentesterlab.com/exercises/pysaml2-ssrf)*

***Fonti:***
- https://github.com/IdentityPython/pysaml2/issues/510

---
# Malicious IDP

In questo caso sarà l'attaccante a creare un Identity Provider (IDP) fasullo sulla propria macchina; poiché il Service Provider non controlla l'affidabilità dell'IDP
 1. **Setup dell'Identity Provider malevolo**
	- Installa e configura un tuo Identity Provider (**IDP**). Puoi usare strumenti come:   
	 - `saml-idp`
	    - `simple-saml-php`
	    - `mocksaml`
	- Oppure, se vuoi fare molto semplice: puoi usare un tool già pronto che genera risposte SAML firmate.
	✅ L'IDP dovrà essere raggiungibile via URL pubblico o localhost (`http://localhost:port/`).
2. **Genera il tuo certificato**
	- Genera una chiave privata e un certificato autofirmato (self-signed) usando OpenSSL:
	    `openssl req -newkey rsa:2048 -nodes -keyout mykey.key -x509 -days 365 -out mycert.crt`
	- Poi estrai il **fingerprint** del certificato:
	    `openssl x509 -noout -fingerprint -sha1 -inform pem -in mycert.crt`
	    Il risultato è quello che userai nel Service Provider.
3. **Configura il Service Provider**
	- Accedi al sito **Service Provider** (quello vulnerabile).
	- Vai nella sezione **SAML Settings** o **Single Sign-On Settings**.
	- Imposta:
	- **IDP URL**: l'URL del tuo IDP (es: `http://localhost:8000/saml/auth`).
    - **Certificate Fingerprint**: quello che hai ottenuto da `openssl`.
	- Salva la configurazione.
4.  **Effettua il login**
	- Adesso prova ad accedere tramite SAML.
	- Inserisci **l'email della vittima** (ad esempio `admin@libcurl.so`).
	- **Non ti serve la password!**
	- Se tutto è configurato correttamente, il Service Provider si fiderà del tuo IDP e ti loggherà come l'utente target (admin!).

---
# Signature Wrapping

In questo caso il SP si fida della firma dell'IDP, perciò è possibile per un attaccante creare una firma digitale ed inviarla al SP durante la fase di login ([CVE-2022-39299](https://github.com/doyensec/CVE-2022-39299_PoC_Generator))

1. Scaricare xmlsec1 https://www.aleksey.com/xmlsec/download/
2. `tar -zxvf xmlsec1-x-xx.tar.gz`
3. `docker run -it -v 'pwd':/code alpine`
4. `apk add libxslt libxslt-dev openssl vim make gcc g++ libxml2-dev bash openssl-dev libltdl`
5. `cd /code/xmlsec1-x-xx` e `./configure --enalble-crypto-dl=no && make install`
6. `xmlsec1`
7. `openssl genrsa -out key.pem`
8. Intercettare con Burpsuite la richiesta di login
9. Copiare il paramentro **SAMLResponse** e
	1. cambiare l'email con quella dell'amministratore in ```<NameID>
	2. rimuovere la firma  ```<`dx:SignatureValue`>``` e lasciare il contenuto vuoto (senza cancellare il tag)
	3. rimuovere i tags  ```<`X509Data`>``` ed il loro contenuto (cancellare il tag in questo caso)
	4. Rimuovere *URI*
10.  Incollare il nuovo **SAMLResponse** ed inviarlo

***Fonti:***
- https://github.com/node-saml/passport-saml

---

